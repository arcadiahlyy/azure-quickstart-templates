{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "domainName": {
            "type": "string",
            "metadata": {
                "description": "Domain name"
            }
        },
        "domainAdmin": {
            "type": "string",
            "metadata": {
                "description": "Domain administrator account name"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the domain administrator account"
            }
        },

        "vnetName": {
            "type": "string",
            "defaultValue": "vnet",
            "metadata": {
                "description": "Virtual network name."
            }
        },
        "subnetName": {
            "type": "string",
            "defaultValue": "Subnet",
            "metadata": {
                "description": "Subnet name."
            }
        },

        "numNodes": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "Number of cluster nodes"
            }
        },
        "vmSize": {
            "type": "string",
            "metadata": {
                "description": "Virtual machine type"
            },
            "defaultValue": "Standard_DS2",
            "allowedValues": [
                "Standard_DS1",
                "Standard_DS2",
                "Standard_DS3",
                "Standard_DS4",
                "Standard_DS11",
                "Standard_DS12",
                "Standard_DS13",
                "Standard_DS14",
                "Standard_GS1",
                "Standard_GS2",
                "Standard_GS3",
                "Standard_GS4",
                "Standard_GS5"
            ]
        },

        "numDisksPerNode": {
            "type": "int",
            "defaultValue": 2,
            "minValue": 0,
            "maxValue": 16,
            "metadata": {
                "description": "Number of data disks per node"
            }
        },
        "diskSizeGb": {
            "type": "int",
            "minValue": 1,
            "maxValue": 1023,
            "metadata": {
                "description": "Data disk size (in GB)"
            }
        },

        "osVersion": {
            "type": "string",
            "metadata": {
                "description": "Windows Server version"
            },
            "allowedValues": [
                "Windows-Server-Technical-Preview",
                "2016-Technical-Preview-with-Containers",
                "2016-Datacenter"
            ],
            "defaultValue": "2016-Datacenter"
        }
    },

    "variables": {

        "vmNamingPrefix": "s2dfs-vm",
        "availabilitySet": "s2d-cluster",
        "storageAccountNamePrefix": "[concat(uniqueString(resourceGroup().id), 's2dfs')]",

        "template": {
            "base": "https://raw.githubusercontent.com/mmarch/azure-quickstart-templates/s2d-template/s2d-cluster/",
            "newNode": "nested/newNode.json"
        },
        "p": {
            "domain": "[concat(' -domain ', parameters('domainName'))]",
            "user": "[concat(' -username ', parameters('domainAdmin'))]",
            "pwd": "[concat(' -password ', parameters('adminPassword'))]",
            "prefix": "[concat(' -nodeNamingPrefix ', 's2dfs-node-')]",
            "numnodes": "[concat(' -numNodes ', parameters('numNodes'))]",
            "sa": "[concat(' -storageAccountName ', 'CloudWitnessStorageAccount')]",
            "saskey": "[concat(' -storageAccountAccessKey ', 'sasKey')]"
        },
        "scriptParameters": "[concat(variables('p').domain, variables('p').user, variables('p').pwd, variables('p').prefix, variables('p').numnodes, variables('p').sa, variables('p').saskey)]"
    },

    "resources": [

        {
            "type": "Microsoft.Compute/availabilitySets",
            "apiVersion": "2015-06-15",
            "location": "[resourceGroup().location]",
            "name": "[variables('availabilitySet')]",
            "properties": {
            }
        },

        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2016-01-01",
            "location": "[resourceGroup().location]",
            "kind": "Storage",
            "copy": {
                "name": "s2dfs-sa-loop",
                "count": "[parameters('numNodes')]"
            },
            "name": "[concat(variables('storageAccountNamePrefix'), copyindex())]",
            "sku": {
                "name": "Premium_LRS"
            },
            "properties": {
            }

        },

        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "copy": {
                "name": "s2dfs-node-loop",
                "count": "[parameters('numNodes')]"
            },
            "name": "[concat('s2dfs-node-', copyindex())]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('template').base, variables('template').newNode)]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[concat(variables('vmNamingPrefix'), copyindex())]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "subnetName": {
                        "value": "[parameters('subnetName')]"
                    },
                    "storageAccountName": {
                        "value": "[concat(variables('storageAccountNamePrefix'), copyindex())]"
                    },
                    "availabilitySet": {
                        "value": "[variables('availabilitySet')]"
                    },

                    "vmSize": {
                        "value": "[parameters('vmSize')]"
                    },
                    "osVersion": {
                        "value": "[parameters('osVersion')]"
                    },
                    "numDataDisks": {
                        "value": "[parameters('numDisksPerNode')]"
                    },
                    "diskSizeGb": {
                        "value": "[parameters('diskSizeGb')]"
                    },

                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "domainAdmin": {
                        "value": "[parameters('domainAdmin')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },

        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2015-06-15",
            "name": "[concat(variables('vmNamingPrefix'), '0/customscript')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "s2dfs-node-loop"
            ],
            "tags": {
                "displayName": "script"
            },
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.8",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[concat(variables('template').base, 'Scripts/script.ps1')]"
                    ]
                },
                "protectedSettings": {
                    "commandToExecute": "[concat( 'powershell -noninteractive -executionpolicy bypass -file script.ps1 ', variables('scriptParameters'), ' >> script.log 2>&1' )]"
                }
            }
        }
    ],

    "outputs": {

        "uniqueString": {
            "type": "string",
            "value": "[concat(variables('template').base, variables('template').newNode)]"
        }
    }
}
